name: Publish page

on:
  push:
    branches:
      - 2.1.3-Alpha

jobs:
  build-and-deploy:
    runs-on: ubuntu-18.04
    env:
      # é…ç½®ç¯å¢ƒå˜é‡ï¼ŒåŒ…æ‹¬é•œåƒçš„åç§°ï¼Œç‰ˆæœ¬å·ï¼Œè¿˜æœ‰å‘½åç©ºé—´
      PRO_NAME: alinesno-platform-press
      PRO_VERSION: 2.1.3-Alpha.${{ github.run_number }}
      DOCKER_HUB_NAMESPACE: luoandong
      EXPOSE_PORT: 84
      #  æ·»åŠ cdné…ç½®
      accessKey: ${{ secrets.QINIU_ACCESS_KEY }}
      secretKey: ${{ secrets.QINIU_SECRET_KEY }}
      spaceBucket: acp-document-site
      remoteFolder: /
      domain: http://acp-document.linesno.com
    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v2
        with:
          persist-credentials: false

      - name: Use Node.js ${{ matrix.node-version }} ğŸ”§ # This example project is built using npm and outputs the result to the 'build' folder. Replace with the commands required to build your project, or remove this step entirely if your site is pre-built.
        uses: actions/setup-node@v1
        with:
          node-version: '16.13.1'

      - name: Install Dependencies
        run: npm i

      - name: Build Docs
        env:
          NODE_OPTIONS: "--max-old-space-size=8192"
        run: npm run docs:build

      # upload to github
      - name: Deploy to GitHub Pages
        uses: crazy-max/ghaction-github-pages@v2
        with:
          # éƒ¨ç½²åˆ° gh-pages åˆ†æ”¯
          target_branch: gh-pages
          # éƒ¨ç½²ç›®å½•ä¸º VuePress çš„é»˜è®¤è¾“å‡ºç›®å½•
          build_dir: docs/.vuepress/dist
        env:
          # @see https://docs.github.com/cn/actions/reference/authentication-in-a-workflow#about-the-github_token-secret
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: ä¸Šä¼ ä¸ƒç‰›
        uses: luochongfei/up2qn@master
        with:
          bucket: alinesno-cloud-platform-press  
          zone:  z2
          access_key: ${{ secrets.QINIU_AK }} 
          secret_key: ${{ secrets.QINIU_SK }} 
          local_dir: docs/.vuepress/dist   
          target_dir: /

      # -->>>>>>>>>>>>>>>>>>>>>>>>>>>>>> éƒ¨ç½²åˆ°docker-hub _start >>>>>>>>>>>>>>>>>>>>>>>>>>
      - name: Log in to Docker Hub
        uses: docker/login-action@f054a8b539a109f9f41c372932f1ae047eff08c9
        with:
          username: ${{ env.DOCKER_HUB_NAMESPACE }}
          password: ${{ secrets.DOCKER_HUB_PASSWORD }}

      - name: Build && Push DockerHub
        uses: docker/build-push-action@ad44023a93711e3deb337508980b4b5e9bcdc5dc
        with:
          context: .
          push: true
          tags: ${{ env.DOCKER_HUB_NAMESPACE }}/${{ env.PRO_NAME }}:${{ env.PRO_VERSION }}
          labels: ${{ steps.meta.outputs.labels }}
            # -->>>>>>>>>>>>>>>>>>>>>>>>>>>>>> éƒ¨ç½²åˆ°docker-hub _end >>>>>>>>>>>>>>>>>>>>>>>>>>
            
  qiniu-and-deploy:
    runs-on: ubuntu-18.04
    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v2
        with:
          persist-credentials: false

      - name: æ‰§è¡Œä¸Šä¼ 
        uses: luochongfei/up2qn@master
        with:
          bucket: alinesno-cloud-platform-press  
          zone: åå— # å­˜å‚¨åŒºåŸŸï¼ŒæŒ‰å®é™…æƒ…å†µå¡«å†™ å¤‡æ³¨1
          access_key: ${{ secrets.AK }} # ä¸ƒç‰›äº‘ AccessKey å¤‡æ³¨2
          secret_key: ${{ secrets.SK }} # ä¸ƒç‰›äº‘ SecretKey å¤‡æ³¨2
          local_dir: web # æœ¬åœ°æ–‡ä»¶å¤¹
          local_exclude: "**/node_modules/**" # è¦æ’é™¤çš„å†…å®¹ï¼Œè¦ç¬¦åˆ glob æ ¼å¼
          target_dir: / # è¦ä¸Šä¼ åˆ°ä¸ƒç‰›äº‘ä¸­çš„æ–‡ä»¶å¤¹

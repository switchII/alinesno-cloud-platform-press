name: Publish page

on:
  push:
    branches:
      - 2.1.3-Alpha

jobs:
  build-and-deploy:
    runs-on: ubuntu-18.04
    env:
      # 配置环境变量，包括镜像的名称，版本号，还有命名空间
      PRO_NAME: alinesno-platform-press
      PRO_VERSION: 2.1.3-Alpha.${{ github.run_number }}
      DOCKER_HUB_NAMESPACE: luoandong
      EXPOSE_PORT: 84
      #  添加cdn配置
      accessKey: ${{ secrets.QINIU_ACCESS_KEY }}
      secretKey: ${{ secrets.QINIU_SECRET_KEY }}
      spaceBucket: acp-document-site
      remoteFolder: /
      domain: http://acp-document.linesno.com
    steps:
      - name: Checkout 🛎️
        uses: actions/checkout@v2
        with:
          persist-credentials: false

      - name: Use Node.js ${{ matrix.node-version }} 🔧 # This example project is built using npm and outputs the result to the 'build' folder. Replace with the commands required to build your project, or remove this step entirely if your site is pre-built.
        uses: actions/setup-node@v1
        with:
          node-version: '16.13.1'

      - name: Install Dependencies
        run: npm i

      - name: Build Docs
        env:
          NODE_OPTIONS: "--max-old-space-size=8192"
        run: npm run docs:build

      # upload to github
      - name: Deploy to GitHub Pages
        uses: crazy-max/ghaction-github-pages@v2
        with:
          # 部署到 gh-pages 分支
          target_branch: gh-pages
          # 部署目录为 VuePress 的默认输出目录
          build_dir: docs/.vuepress/dist
        env:
          # @see https://docs.github.com/cn/actions/reference/authentication-in-a-workflow#about-the-github_token-secret
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: 上传七牛
        uses: luochongfei/up2qn@master
        with:
          bucket: alinesno-cloud-platform-press  
          zone:  z2
          access_key: ${{ secrets.QINIU_AK }} 
          secret_key: ${{ secrets.QINIU_SK }} 
          local_dir: docs/.vuepress/dist   
          target_dir: /

      # -->>>>>>>>>>>>>>>>>>>>>>>>>>>>>> 部署到docker-hub _start >>>>>>>>>>>>>>>>>>>>>>>>>>
      - name: Log in to Docker Hub
        uses: docker/login-action@f054a8b539a109f9f41c372932f1ae047eff08c9
        with:
          username: ${{ env.DOCKER_HUB_NAMESPACE }}
          password: ${{ secrets.DOCKER_HUB_PASSWORD }}

      - name: Build && Push DockerHub
        uses: docker/build-push-action@ad44023a93711e3deb337508980b4b5e9bcdc5dc
        with:
          context: .
          push: true
          tags: ${{ env.DOCKER_HUB_NAMESPACE }}/${{ env.PRO_NAME }}:${{ env.PRO_VERSION }}
          labels: ${{ steps.meta.outputs.labels }}
            # -->>>>>>>>>>>>>>>>>>>>>>>>>>>>>> 部署到docker-hub _end >>>>>>>>>>>>>>>>>>>>>>>>>>
            
  qiniu-and-deploy:
    runs-on: ubuntu-18.04
    steps:
      - name: Checkout 🛎️
        uses: actions/checkout@v2
        with:
          persist-credentials: false

      - name: 执行上传
        uses: luochongfei/up2qn@master
        with:
          bucket: alinesno-cloud-platform-press  
          zone: 华南 # 存储区域，按实际情况填写 备注1
          access_key: ${{ secrets.AK }} # 七牛云 AccessKey 备注2
          secret_key: ${{ secrets.SK }} # 七牛云 SecretKey 备注2
          local_dir: web # 本地文件夹
          local_exclude: "**/node_modules/**" # 要排除的内容，要符合 glob 格式
          target_dir: / # 要上传到七牛云中的文件夹
